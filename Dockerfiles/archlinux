FROM pritunl/archlinux

# denotes whether shared or static tensorflow is built
ARG shared=OFF

# install requirements
RUN pacman -S --noconfirm --needed \
      base-devel \
      cmake \
      cuda \
      cudnn \
      gcc6 \
      bazel \
      git \
      unzip \
      mlocate \
      python \
      python-numpy \
      wget \
  && paccache -rfk0

# when building TF with Intel MKL support, `locate` database needs to exist
RUN updatedb

# copy the contents of this repository to the container
COPY . tensorflow_cc
# alternatively, clone the repository
# RUN git clone https://github.com/FloopCZ/tensorflow_cc.git

# build and install tensorflow_cc
RUN mkdir /tensorflow_cc/tensorflow_cc/build \
  && cd /tensorflow_cc/tensorflow_cc/build \
  # configure only shared or only static library
  && if [ "${shared}" = "OFF" ]; then \
         cmake ..; \
     else \
         cmake -DTENSORFLOW_STATIC=OFF -DTENSORFLOW_SHARED=ON ..; \
     fi \
  # build
  && make \
  # cleanup after bazel
  && rm -rf ~/.cache \
  # install
  && make install \
  # cleanup build folder
  && cd / \
  && rm -rf /tensorflow_cc/tensorflow_cc/build

# build and run example
RUN mkdir /tensorflow_cc/example/build
WORKDIR /tensorflow_cc/example/build
RUN cmake .. && make && ./example
